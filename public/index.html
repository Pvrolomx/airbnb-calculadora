<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Calculadora de Reserva ‚Äì Host Neto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
        display: flex;
        min-height: 100vh;
        justify-content: center;
        align-items: flex-start;
        padding: 24px;
      }

      .app-shell {
        width: 100%;
        max-width: 1000px;
        background: radial-gradient(circle at top, #0f172a, #020617 60%);
        border-radius: 16px;
        border: 1px solid #1f2937;
        padding: 20px 20px 24px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      }

      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .app-title {
        font-size: 18px;
        font-weight: 600;
        color: #f9fafb;
      }

      .app-subtitle {
        font-size: 13px;
        color: #9ca3af;
      }

      .lang-toggle {
        border-radius: 999px;
        border: 1px solid #4b5563;
        padding: 3px 10px;
        font-size: 12px;
        background: #020617;
        color: #e5e7eb;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .lang-toggle span.flag {
        font-size: 14px;
      }

      .app-body {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
        gap: 16px;
      }

      @media (max-width: 800px) {
        .app-body {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 12px;
        border: 1px solid #1f2937;
        padding: 16px 16px 18px;
      }

      .card-title {
        font-size: 14px;
        font-weight: 600;
        color: #f9fafb;
        margin-bottom: 10px;
      }

      .input-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 600px) {
        .input-grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .input-label {
        font-size: 12px;
        color: #d1d5db;
      }

      .input-field {
        border-radius: 8px;
        border: 1px solid #374151;
        background: #020617;
        color: #f9fafb;
        padding: 6px 8px;
        font-size: 13px;
      }

      .input-field:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      }

      .actions-row {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 10px;
        margin-top: 14px;
      }

      .btn-primary {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        background: #22c55e;
        color: #020617;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #e5e7eb;
        font-size: 13px;
        cursor: pointer;
      }

      .result-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        margin-top: 10px;
      }

      .result-item {
        padding: 8px 10px;
        border-radius: 8px;
        background: #020617;
        border: 1px solid #111827;
      }

      .result-label {
        font-size: 11px;
        color: #9ca3af;
      }

      .result-value {
        font-size: 14px;
        font-weight: 600;
        margin-top: 2px;
      }

      .result-value.positive {
        color: #22c55e;
      }

      .result-value.negative {
        color: #f97373;
      }

      .disclaimer {
        margin-top: 10px;
        font-size: 11px;
        color: #6b7280;
      }

      .disclaimer strong {
        color: #e5e7eb;
      }

      .side-card-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .side-highlight {
        padding: 10px;
        border-radius: 8px;
        background: #020617;
        border: 1px dashed #4b5563;
        font-size: 12px;
        color: #d1d5db;
      }

      .side-highlight strong {
        color: #22c55e;
      }

      .log-panel {
        margin-top: 6px;
        max-height: 130px;
        overflow-y: auto;
        font-size: 11px;
        background: #020617;
        border-radius: 8px;
        border: 1px solid #111827;
        padding: 6px 8px;
        color: #9ca3af;
        white-space: pre-line;
      }

      /* ======= PASTILLAS DE PLATAFORMA (ESTILO AIRBNB) ======= */

      .platform-group {
        margin-bottom: 12px;
      }

      .platform-label {
        display: block;
        margin-bottom: 6px;
        font-size: 12px;
        color: #e5e7eb;
      }

      .platform-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .platform-pills input[type="radio"] {
        display: none;
      }

      .platform-pills label {
        padding: 5px 12px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        font-size: 12px;
        color: #e5e7eb;
        cursor: pointer;
        transition: all 0.15s ease;
        background: #020617;
      }

      .platform-pills label:hover {
        border-color: #22c55e;
      }

      .platform-pills input[type="radio"]:checked + label {
        background: #22c55e;
        border-color: #22c55e;
        color: #020617;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div>
          <div id="app-title" class="app-title">
            Calculadora de reserva (estimaci√≥n neta)
          </div>
          <div id="app-subtitle" class="app-subtitle">
            Ingresa los datos de una reserva y obt√©n una estimaci√≥n informativa
            de ingresos, gastos e impuestos.
          </div>
        </div>
        <button id="lang-toggle" class="lang-toggle" type="button">
          <span class="flag">üá≤üáΩ</span>
          <span id="lang-toggle-text">ES</span>
        </button>
      </header>

      <main class="app-body">
        <!-- COLUMNA IZQUIERDA: FORM -->
        <section class="card">
          <div class="card-title" id="form-title">
            Datos de la reserva
          </div>

          <form id="calc-form">
            <!-- PLATAFORMA -->
            <div class="platform-group">
              <span id="label-platform" class="platform-label">
                Plataforma / canal de reserva
              </span>
              <div class="platform-pills">
                <input
                  type="radio"
                  name="plataforma"
                  id="plat-airbnb"
                  value="AIRBNB"
                  checked
                />
                <label for="plat-airbnb">Airbnb</label>

                <input
                  type="radio"
                  name="plataforma"
                  id="plat-vrbo"
                  value="VRBO"
                />
                <label for="plat-vrbo">Vrbo</label>

                <input
                  type="radio"
                  name="plataforma"
                  id="plat-booking"
                  value="BOOKING"
                />
                <label for="plat-booking">Booking.com</label>

                <input
                  type="radio"
                  name="plataforma"
                  id="plat-otra"
                  value="OTRA"
                />
                <label for="plat-otra">Otra</label>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-group">
                <label class="input-label" id="label-tarifa-noche" for="tarifa_noche">
                  Tarifa por noche (MXN)
                </label>
                <input
                  id="tarifa_noche"
                  class="input-field"
                  type="number"
                  step="0.01"
                  min="0"
                  value="500"
                />
              </div>

              <div class="input-group">
                <label class="input-label" id="label-noches" for="noches">
                  Noches
                </label>
                <input
                  id="noches"
                  class="input-field"
                  type="number"
                  min="1"
                  step="1"
                  value="3"
                />
              </div>

              <div class="input-group">
                <label class="input-label" id="label-tarifa-limpieza" for="tarifa_limpieza">
                  Tarifa de limpieza cobrada (MXN)
                </label>
                <input
                  id="tarifa_limpieza"
                  class="input-field"
                  type="number"
                  step="0.01"
                  min="0"
                  value="200"
                />
              </div>

              <div class="input-group">
                <label class="input-label" id="label-regimen" for="regimen_fiscal">
                  R√©gimen fiscal (aprox.)
                </label>
                <select id="regimen_fiscal" class="input-field">
                  <option id="opt-regimen-sinrfc" value="SIN_RFC">Sin RFC / plataforma retiene</option>
                  <option id="opt-regimen-resico" value="RESICO" selected>RESICO</option>
                  <option id="opt-regimen-actividad" value="ACTIVIDAD_EMPRESARIAL">Actividad empresarial</option>
                </select>
              </div>

              <div class="input-group">
                <label class="input-label" id="label-gasto-limpieza" for="gasto_limpieza_real">
                  Gasto real de limpieza (MXN)
                </label>
                <input
                  id="gasto_limpieza_real"
                  class="input-field"
                  type="number"
                  step="0.01"
                  min="0"
                  value="150"
                />
              </div>

              <div class="input-group">
                <label class="input-label" id="label-gasto-consumibles" for="gasto_consumibles">
                  Gasto en consumibles (MXN)
                </label>
                <input
                  id="gasto_consumibles"
                  class="input-field"
                  type="number"
                  step="0.01"
                  min="0"
                  value="50"
                />
              </div>

              <div class="input-group">
                <label class="input-label" id="label-gasto-otras" for="gasto_comisiones_otras">
                  Otras comisiones / gastos (MXN)
                </label>
                <input
                  id="gasto_comisiones_otras"
                  class="input-field"
                  type="number"
                  step="0.01"
                  min="0"
                  value="0"
                />
              </div>
            </div>

            <div class="actions-row">
              <button id="btn-calcular" class="btn-primary" type="submit">
                <span id="btn-calcular-text">Calcular estimado</span>
              </button>
            </div>
          </form>

          <div id="results" class="result-row" style="display: none">
            <div class="result-item">
              <div class="result-label" id="res-label-ingreso-bruto">
                Ingreso bruto (reserva)
              </div>
              <div
                id="res-ingreso-bruto"
                class="result-value"
              >
                ‚Äî
              </div>
            </div>

            <div class="result-item">
              <div class="result-label" id="res-label-comision">
                Comisi√≥n plataforma (estimada)
              </div>
              <div
                id="res-comision"
                class="result-value"
              >
                ‚Äî
              </div>
            </div>

            <div class="result-item">
              <div class="result-label" id="res-label-gastos">
                Gastos directos reserva
              </div>
              <div
                id="res-gastos"
                class="result-value"
              >
                ‚Äî
              </div>
            </div>

            <div class="result-item">
              <div class="result-label" id="res-label-impuestos">
                Impuesto estimado (aprox.)
              </div>
              <div
                id="res-impuestos"
                class="result-value"
              >
                ‚Äî
              </div>
            </div>

            <div class="result-item">
              <div class="result-label" id="res-label-ganancia-neta">
                Ganancia neta estimada
              </div>
              <div
                id="res-ganancia-neta"
                class="result-value positive"
              >
                ‚Äî
              </div>
            </div>
          </div>

          <div class="disclaimer" id="disclaimer-text">
            <strong>Importante:</strong> Esta herramienta ofrece c√°lculos
            aproximados con fines informativos. No constituye asesor√≠a fiscal,
            contable ni legal.
          </div>
        </section>

        <!-- COLUMNA DERECHA: INFO / LOG -->
        <aside class="card">
          <div class="card-title" id="side-title">
            Qu√© hace esta herramienta
          </div>
          <div class="side-card-body">
            <div class="side-highlight" id="side-highlight-text">
              Calcula, para una sola reserva, una estimaci√≥n de:
              <br />
              ‚Ä¢ Ingreso bruto<br />
              ‚Ä¢ Comisi√≥n de la plataforma (seg√∫n selecci√≥n)<br />
              ‚Ä¢ Gastos directos que ingresas<br />
              ‚Ä¢ Impuesto aproximado con tasa fija<br />
              ‚Ä¢ Ganancia neta estimada
            </div>

            <div class="side-highlight" id="side-platform-note">
              <strong>Nota de plataforma:</strong><br />
              ‚Ä¢ Airbnb: 3% (aprox. comisi√≥n host)<br />
              ‚Ä¢ Vrbo: 8% (aprox.)<br />
              ‚Ä¢ Booking.com: 15% (aprox.)<br />
              ‚Ä¢ Otra: 0% (puedes ajustar en backend)
            </div>

            <div>
              <div
                style="font-size: 12px; color: #9ca3af; margin-bottom: 4px"
                id="side-log-title"
              >
                Log de c√°lculo (√∫ltimas ejecuciones)
              </div>
              <div id="log-panel" class="log-panel"></div>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <script>
      // ===== Textos ES/EN =====
      const texts = {
        es: {
          title: "Calculadora de reserva (estimaci√≥n neta)",
          subtitle:
            "Ingresa los datos de una reserva y obt√©n una estimaci√≥n informativa de ingresos, gastos e impuestos.",
          formTitle: "Datos de la reserva",
          labelPlatform: "Plataforma / canal de reserva",
          labelTarifaNoche: "Tarifa por noche (MXN)",
          labelNoches: "Noches",
          labelTarifaLimpieza: "Tarifa de limpieza cobrada (MXN)",
          labelRegimen: "R√©gimen fiscal (aprox.)",
          labelGastoLimpieza: "Gasto real de limpieza (MXN)",
          labelGastoConsumibles: "Gasto en consumibles (MXN)",
          labelGastoOtras: "Otras comisiones / gastos (MXN)",
          btnCalcular: "Calcular estimado",
          resIngresoBruto: "Ingreso bruto (reserva)",
          resComision: "Comisi√≥n plataforma (estimada)",
          resGastos: "Gastos directos reserva",
          resImpuestos: "Impuesto estimado (aprox.)",
          resGananciaNeta: "Ganancia neta estimada",
          sideTitle: "Qu√© hace esta herramienta",
          sideHighlight:
            "Calcula, para una sola reserva, una estimaci√≥n de:\n‚Ä¢ Ingreso bruto\n‚Ä¢ Comisi√≥n de la plataforma (seg√∫n selecci√≥n)\n‚Ä¢ Gastos directos que ingresas\n‚Ä¢ Impuesto aproximado con tasa fija\n‚Ä¢ Ganancia neta estimada",
          sidePlatformNote:
            "Nota de plataforma:\n‚Ä¢ Airbnb: 3% (aprox. comisi√≥n host)\n‚Ä¢ Vrbo: 8% (aprox.)\n‚Ä¢ Booking.com: 15% (aprox.)\n‚Ä¢ Otra: 0% (puedes ajustar en backend)",
          sideLogTitle: "Log de c√°lculo (√∫ltimas ejecuciones)",
          disclaimer:
            "Importante: Esta herramienta ofrece c√°lculos aproximados con fines informativos. No constituye asesor√≠a fiscal, contable ni legal.",
          // NUEVO: textos de las opciones del select
          regimenOptionSinRfc: "Sin RFC / plataforma retiene",
          regimenOptionResico: "RESICO",
          regimenOptionActividad: "Actividad empresarial",
        },
        en: {
          title: "Booking calculator (net estimate)",
          subtitle:
            "Enter a single booking and get an informative estimate of income, expenses and taxes.",
          formTitle: "Booking data",
          labelPlatform: "Platform / channel",
          labelTarifaNoche: "Nightly rate (MXN)",
          labelNoches: "Nights",
          labelTarifaLimpieza: "Cleaning fee charged (MXN)",
          labelRegimen: "Tax category (approx.)",
          labelGastoLimpieza: "Actual cleaning cost (MXN)",
          labelGastoConsumibles: "Supplies cost (MXN)",
          labelGastoOtras: "Other fees / costs (MXN)",
          btnCalcular: "Calculate estimate",
          resIngresoBruto: "Gross income (booking)",
          resComision: "Platform commission (estimated)",
          resGastos: "Direct booking expenses",
          resImpuestos: "Estimated tax (approx.)",
          resGananciaNeta: "Estimated net income",
          sideTitle: "What this tool does",
          sideHighlight:
            "For a single booking, it estimates:\n‚Ä¢ Gross income\n‚Ä¢ Platform commission (based on selection)\n‚Ä¢ Direct expenses you enter\n‚Ä¢ Approx. tax with fixed rate\n‚Ä¢ Estimated net income",
          sidePlatformNote:
            "Platform note:\n‚Ä¢ Airbnb: 3% (approx. host commission)\n‚Ä¢ Vrbo: 8% (approx.)\n‚Ä¢ Booking.com: 15% (approx.)\n‚Ä¢ Other: 0% (you can tweak in backend)",
          sideLogTitle: "Calculation log (last runs)",
          disclaimer:
            "Important: This tool provides approximate calculations for informational purposes only. It does not constitute tax, accounting or legal advice.",
          // NUEVO: textos de opciones del select
          regimenOptionSinRfc: "No tax ID / platform withholds",
          regimenOptionResico: "RESICO",
          regimenOptionActividad: "Business activity",
        },
      };

      let currentLang = "es";

      function applyLang(lang) {
        const t = texts[lang];
        document.documentElement.lang = lang;
        document.getElementById("app-title").innerText = t.title;
        document.getElementById("app-subtitle").innerText = t.subtitle;
        document.getElementById("form-title").innerText = t.formTitle;
        document.getElementById("label-platform").innerText = t.labelPlatform;
        document.getElementById("label-tarifa-noche").innerText =
          t.labelTarifaNoche;
        document.getElementById("label-noches").innerText = t.labelNoches;
        document.getElementById("label-tarifa-limpieza").innerText =
          t.labelTarifaLimpieza;
        document.getElementById("label-regimen").innerText = t.labelRegimen;
        document.getElementById("label-gasto-limpieza").innerText =
          t.labelGastoLimpieza;
        document.getElementById("label-gasto-consumibles").innerText =
          t.labelGastoConsumibles;
        document.getElementById("label-gasto-otras").innerText =
          t.labelGastoOtras;
        document.getElementById("btn-calcular-text").innerText =
          t.btnCalcular;
        // üîΩüîΩ NUEVO: cambiar textos del select seg√∫n idioma
        document.getElementById("opt-regimen-sinrfc").textContent =
          t.regimenOptionSinRfc;
        document.getElementById("opt-regimen-resico").textContent =
          t.regimenOptionResico;
        document.getElementById("opt-regimen-actividad").textContent =
          t.regimenOptionActividad;
        // üîºüîº NUEVO
        document.getElementById("res-label-ingreso-bruto").innerText =
          t.resIngresoBruto;
        document.getElementById("res-label-comision").innerText =
          t.resComision;
        document.getElementById("res-label-gastos").innerText = t.resGastos;
        document.getElementById("res-label-impuestos").innerText =
          t.resImpuestos;
        document.getElementById("res-label-ganancia-neta").innerText =
          t.resGananciaNeta;
        document.getElementById("side-title").innerText = t.sideTitle;
        document.getElementById("side-highlight-text").innerText =
          t.sideHighlight;
        document.getElementById("side-platform-note").innerText =
          t.sidePlatformNote;
        document.getElementById("side-log-title").innerText =
          t.sideLogTitle;
        document.getElementById("disclaimer-text").innerText = t.disclaimer;

        const langToggleText = document.getElementById("lang-toggle-text");
        const langToggleFlag = document.querySelector("#lang-toggle .flag");

        if (lang === "es") {
          langToggleText.textContent = "ES";
          langToggleFlag.textContent = "üá≤üáΩ";
        } else {
          langToggleText.textContent = "EN";
          langToggleFlag.textContent = "üá∫üá∏";
        }
      }

      document
        .getElementById("lang-toggle")
        .addEventListener("click", () => {
          currentLang = currentLang === "es" ? "en" : "es";
          applyLang(currentLang);
        });

      // Primer render ES
      applyLang("es");

      // ===== FUNCIONES DE C√ÅLCULO / API =====

      function buildInputFromForm() {
        const plataformaInput = document.querySelector(
          'input[name="plataforma"]:checked'
        );
        const plataforma = plataformaInput
          ? plataformaInput.value
          : "AIRBNB";

        return {
          tarifa_noche: Number(
            document.getElementById("tarifa_noche").value || 0
          ),
          noches: Number(document.getElementById("noches").value || 0),
          tarifa_limpieza: Number(
            document.getElementById("tarifa_limpieza").value || 0
          ),
          regimen_fiscal: document.getElementById("regimen_fiscal").value,
          gasto_limpieza_real: Number(
            document.getElementById("gasto_limpieza_real").value || 0
          ),
          gasto_consumibles: Number(
            document.getElementById("gasto_consumibles").value || 0
          ),
          gasto_comisiones_otras: Number(
            document.getElementById("gasto_comisiones_otras").value || 0
          ),
          plataforma,
        };
      }

      function appendLog(message) {
        const panel = document.getElementById("log-panel");
        const now = new Date().toLocaleTimeString();
        panel.textContent =
          `[${now}] ${message}\n` + (panel.textContent || "");
      }

      const formEl = document.getElementById("calc-form");
      const btnCalcular = document.getElementById("btn-calcular");

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = buildInputFromForm();

        btnCalcular.disabled = true;
        appendLog("Enviando c√°lculo al backend‚Ä¶");

        try {
          const res = await fetch("/calcular", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            appendLog(
              `Error HTTP ${res.status}: ${
                err.error || "Error desconocido"
              }`
            );
            alert(
              err.error ||
                "Ocurri√≥ un error al calcular. Revisa los datos ingresados."
            );
            return;
          }

          const data = await res.json();
          appendLog("C√°lculo exitoso.");

          const r = data.resultado;

          document.getElementById("res-ingreso-bruto").textContent =
            r.ingreso_bruto_reserva.toFixed(2) + " MXN";
          document.getElementById("res-comision").textContent =
            r.comision_airbnb_reserva.toFixed(2) + " MXN";
          document.getElementById("res-gastos").textContent =
            r.gastos_reserva.toFixed(2) + " MXN";
          document.getElementById("res-impuestos").textContent =
            r.impuestos_estimados_reserva.toFixed(2) + " MXN";

          const netEl = document.getElementById("res-ganancia-neta");
          netEl.textContent =
            r.ganancia_neta_reserva.toFixed(2) + " MXN";
          netEl.classList.remove("positive", "negative");
          netEl.classList.add(
            r.ganancia_neta_reserva >= 0 ? "positive" : "negative"
          );

          document.getElementById("results").style.display = "grid";
        } catch (err) {
          console.error(err);
          appendLog("Error de red o JS en el navegador.");
          alert(
            "No se pudo contactar al backend. Aseg√∫rate de que el servidor est√° corriendo."
          );
        } finally {
          btnCalcular.disabled = false;
        }
      });
    </script>
  </body>
</html>
